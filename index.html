<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto-Extractor de Cronologías — API-Football (sin proxys)</title>
  <style>
    :root{--bg:#0b1222;--panel:#0f172a;--edge:#18212f;--text:#e2e8f0;--muted:#93a4b3;--accent:#22d3ee}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{padding:16px 18px;border-bottom:1px solid var(--edge);background:#09101e;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .panel{background:#0f172a;border:1px solid var(--edge);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{background:#09101e;color:var(--text);border:1px solid var(--edge);border-radius:12px;padding:10px 12px}
    input:focus{outline:1px solid var(--accent)}
    button{cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#0ea5b6,#22d3ee);border:none;color:#001319}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:0}
    #progress{display:none;gap:8px;align-items:center}
    .bar{flex:1;min-width:240px;height:10px;background:#0b1222;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#0ea5b6,#22d3ee)}
    .ptext{min-width:120px;text-align:right;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="row" style="align-items:center;justify-content:space-between">
      <h1>Auto-Extractor de Cronologías — API-Football</h1>
      <div class="muted mono">sin proxys • sin CORS • con tiros, posesión y eventos</div>
    </div>
  </header>

  <main>
    <!-- API KEY -->
    <section class="panel">
      <h2 style="margin:0 0 8px 0">1) API Key</h2>
      <div class="row">
        <input id="apiKey" placeholder="Tu API Key de RapidAPI (API-Football)" style="min-width:360px">
        <button onclick="saveKey()">Guardar</button>
        <span id="keyStatus" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:6px">
        Consíguela gratis en RapidAPI → API-Football. No hay proxys ni CORS.
      </div>
    </section>

    <!-- 6 ESPACIOS -->
    <section class="panel">
      <h2 style="margin:0 0 8px 0">2) Parámetros</h2>
      <div class="row">
        <input id="equipoA" placeholder="Equipo A (ej.: Barcelona)">
        <input id="equipoB" placeholder="Equipo B (ej.: PSG)">
        <input id="nA" type="number" min="0" placeholder="# partidos A (ej.: 3)">
        <input id="nB" type="number" min="0" placeholder="# partidos B (ej.: 3)">
        <input id="nH2H" type="number" min="0" placeholder="# H2H (ej.: 3)">
        <input id="competicionGlobal" placeholder="Competición (opcional)">
      </div>

      <div id="progress" class="row" style="margin-top:10px">
        <div class="bar"><div class="fill" id="pfill"></div></div>
        <div class="ptext" id="ptext">0%</div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn primary" onclick="runAll()">Extraer automáticamente</button>
        <button onclick="clearAll()">Limpiar</button>
        <span id="status" class="muted mono"></span>
      </div>
    </section>

    <!-- SALIDA -->
    <section class="panel">
      <h2 style="margin:0 0 8px 0">3) Salida (formato exacto)</h2>
      <pre id="out" class="mono"></pre>
      <div class="row" style="margin-top:8px">
        <button onclick="copyOut()">Copiar</button>
      </div>
    </section>

    <!-- LOG -->
    <section class="panel">
      <h2 style="margin:0 0 8px 0">Log</h2>
      <pre id="log" class="mono"></pre>
    </section>

    <!-- DIAGNÓSTICO -->
    <section class="panel">
      <h2 style="margin:0 0 8px 0">Diagnóstico</h2>
      <pre id="diag" class="mono"></pre>
    </section>
  </main>

<script>
const S = {
  apiKey: localStorage.getItem('apif_key') || ''
};
const $ = s => document.querySelector(s);

function saveKey(){
  S.apiKey = $('#apiKey').value.trim();
  localStorage.setItem('apif_key', S.apiKey);
  $('#keyStatus').textContent = S.apiKey ? 'API Key guardada' : 'API Key vacía';
}
(function init(){
  $('#apiKey').value = S.apiKey;
  $('#keyStatus').textContent = S.apiKey ? 'API Key guardada' : 'API Key vacía';
})();

function log(m){ const el=$('#log'); el.textContent += (el.textContent?'\n':'') + m; }
function diag(m){ const el=$('#diag'); el.textContent += (el.textContent?'\n':'') + `[${new Date().toLocaleTimeString()}] ${m}`; }
function setStatus(m){ $('#status').textContent = m; }
function clearAll(){ $('#out').textContent=''; $('#log').textContent=''; $('#diag').textContent=''; setStatus(''); progressHide(); }
function copyOut(){ const t=$('#out').textContent; if(!t){alert('No hay salida');return;} navigator.clipboard.writeText(t).then(()=>alert('Copiado')); }
function progressShow(){ $('#progress').style.display='flex'; }
function progressHide(){ $('#progress').style.display='none'; }
function progress(p,msg){ progressShow(); $('#pfill').style.width=Math.max(0,Math.min(100,p))+'%'; $('#ptext').textContent=(Math.round(p))+'%'; if(msg) setStatus(msg); }

const BASE = 'https://api-football-v1.p.rapidapi.com/v3';

// ------- helpers API-Football -------
async function afetch(path, params = {}) {
  if (!S.apiKey) throw new Error('Falta API Key (RapidAPI)');
  const url = new URL(BASE + path);
  for (const [k,v] of Object.entries(params)) if (v!==undefined && v!==null && v!=='') url.searchParams.set(k, v);
  const r = await fetch(url.toString(), {
    headers: {
      'x-rapidapi-host': 'api-football-v1.p.rapidapi.com',
      'x-rapidapi-key': S.apiKey
    }
  });
  const txt = await r.text();
  let json = null;
  try { json = JSON.parse(txt); } catch {
    throw new Error('Respuesta no-JSON de API-Football: '+txt.slice(0,160));
  }
  if (!r.ok) {
    const msg = json?.message || json?.errors || ('HTTP '+r.status);
    throw new Error('API-Football error: '+JSON.stringify(msg));
  }
  return json;
}

// Busca equipo por nombre → id
async function findTeamByName(name){
  const j = await afetch('/teams', { search: name });
  const list = j?.response || [];
  if (!list.length) throw new Error('No se encontró equipo: '+name);
  const hit = list[0];
  return { id: hit.team.id, name: hit.team.name, country: hit.team.country };
}

// Últimos N partidos del equipo
async function lastMatches(teamId, n){
  const j = await afetch('/fixtures', { team: teamId, last: n });
  return j?.response || [];
}

// Eventos de un fixture
async function fixtureEvents(fixtureId){
  const j = await afetch('/fixtures/events', { fixture: fixtureId });
  return j?.response || [];
}

// Estadísticas de un fixture
async function fixtureStats(fixtureId){
  const j = await afetch('/fixtures/statistics', { fixture: fixtureId });
  const teams = j?.response || [];
  const out = { possessionHome:null, possessionAway:null, shotsHome:null, shotsAway:null, xgHome:null, xgAway:null };
  if (teams.length >= 2) {
    const A = teams[0].statistics || [];
    const B = teams[1].statistics || [];
    const find = (arr, key) => (arr.find(x => (x.type||'').toLowerCase().includes(key)) || {}).value;
    const n = v => {
      if (v==null) return null;
      if (typeof v === 'number') return v;
      const s = (''+v).trim();
      if (s.endsWith('%')) return parseFloat(s);
      const f = parseFloat(s.replace(',','.'));
      return isNaN(f) ? null : f;
    };
    out.possessionHome = n(find(A,'possession'));
    out.possessionAway = n(find(B,'possession'));
    const shA = n(find(A,'shots on goal')) ?? n(find(A,'shots on target'));
    const stA = n(find(A,'total shots')) ?? n(find(A,'shots total')) ?? n(find(A,'shots'));
    const shB = n(find(B,'shots on goal')) ?? n(find(B,'shots on target'));
    const stB = n(find(B,'total shots')) ?? n(find(B,'shots total')) ?? n(find(B,'shots'));
    out.shotsHome = (stA!=null||shA!=null) ? { total: stA, onTarget: shA } : null;
    out.shotsAway = (stB!=null||shB!=null) ? { total: stB, onTarget: shB } : null;
    out.xgHome = n(find(A,'xg')) ?? null;
    out.xgAway = n(find(B,'xg')) ?? null;
  }
  return out;
}

// Formateo de eventos
function formatEvents(events, homeName, awayName){
  const lines = [];
  const sort = [...events].sort((a,b)=>{
    const ma = (a.time?.elapsed||0) + (a.time?.extra||0)/100;
    const mb = (b.time?.elapsed||0) + (b.time?.extra||0)/100;
    return ma - mb;
  });
  for(const e of sort){
    const min = e.time?.extra ? `${e.time.elapsed}+${e.time.extra}` : (e.time?.elapsed ?? '?');
    const team = e.team?.name || '';
    const player = e.player?.name ? ` - ${e.player.name}` : '';
    const asst = e.assist?.name ? ` (Asistencia: ${e.assist.name})` : '';
    let tipo = e.type || '';
    if (tipo==='Goal') tipo = 'Gol';
    else if (tipo==='Card' && /yellow/i.test(e.detail||'')) tipo = 'Tarjeta Amarilla';
    else if (tipo==='Card' && /red/i.test(e.detail||'')) tipo = 'Tarjeta Roja';
    else if (tipo==='subst' || /substitution/i.test(tipo)) tipo = 'Cambio';
    else if (/var/i.test(tipo)) tipo = 'VAR';
    const det = e.detail ? (tipo==='Gol' ? ` ${e.detail.includes('Own Goal')?'(Auto)':''}${e.detail.includes('Penalty')?' (Penalti)':''}` : ` (${e.detail})`) : '';
    lines.push(`[${min}'] ${tipo}${det} - ${team}${player}${asst}`);
  }
  return lines;
}

function formatBlock(fx, eventsText, stats){
  const date = fx.fixture?.date ? new Date(fx.fixture.date).toISOString().slice(0,10) : '-';
  const comp = fx.league?.name || '-';
  const home = fx.teams?.home?.name || 'Local';
  const away = fx.teams?.away?.name || 'Visitante';
  const hs = fx.goals?.home ?? fx.score?.fulltime?.home ?? '-';
  const as = fx.goals?.away ?? fx.score?.fulltime?.away ?? '-';

  const parts = [];
  parts.push(`Fecha: ${date}`);
  parts.push(`Competición: ${comp}`);
  parts.push(`Equipos: ${home} vs ${away}`);
  parts.push(`Resultado Final: ${hs}-${as}`);

  if (stats.shotsHome || stats.shotsAway) {
    const shA = stats.shotsHome ? `${home} ${stats.shotsHome.total ?? '-'}${stats.shotsHome.onTarget!=null?` (${stats.shotsHome.onTarget} al arco)`:''}` : '';
    const shB = stats.shotsAway ? `${away} ${stats.shotsAway.total ?? '-'}${stats.shotsAway.onTarget!=null?` (${stats.shotsAway.onTarget} al arco)`:''}` : '';
    parts.push(`Tiros Totales: ${shA}${shA&&shB?`, `:''}${shB}`);
  }
  if (stats.possessionHome!=null && stats.possessionAway!=null) {
    parts.push(`Posesión: ${home} ${stats.possessionHome}% , ${away} ${stats.possessionAway}%`);
  }
  if (stats.xgHome!=null && stats.xgAway!=null) {
    parts.push(`xG: ${home} ${stats.xgHome} , ${away} ${stats.xgAway}`);
  }

  parts.push(`\nEventos:`);
  parts.push(...eventsText);
  return parts.join('\n');
}

// ====== Flujo principal ======
async function runAll(){
  try{
    clearAll();
    const Aname = $('#equipoA').value.trim();
    const Bname = $('#equipoB').value.trim();
    if(!Aname || !Bname){ alert('Escribe Equipo A y Equipo B'); return; }
    if(!S.apiKey){ alert('Pega tu API Key primero'); return; }

    progress(5,'Buscando equipos…');
    const A = await findTeamByName(Aname); log(`Equipo A: ${A.name} (#${A.id})`);
    const B = await findTeamByName(Bname); log(`Equipo B: ${B.name} (#${B.id})`);
    let pct=10;
    const nA=+($('#nA').value||0), nB=+($('#nB').value||0), nH2H=+($('#nH2H').value||0);
    const total=(nA>0?nA:0)+(nB>0?nB:0)+(nH2H>0?nH2H:0);
    const step = total? Math.max(85/total,3) : 10;

    const blocks=[];

    async function processFx(fx){
      const [evs, stats] = await Promise.all([
        fixtureEvents(fx.fixture.id),
        fixtureStats(fx.fixture.id).catch(()=>({}))
      ]);
      const lines = formatEvents(evs, fx.teams?.home?.name, fx.teams?.away?.name);
      blocks.push( formatBlock(fx, lines, stats||{}) );
      pct+=step; progress(Math.min(98,pct),'Procesando…');
    }

    if(nA>0){
      setStatus(`Descargando últimos ${nA} de ${A.name}…`);
      const list = await lastMatches(A.id, nA);
      for(const fx of list) await processFx(fx);
    }
    if(nB>0){
      setStatus(`Descargando últimos ${nB} de ${B.name}…`);
      const list = await lastMatches(B.id, nB);
      for(const fx of list) await processFx(fx);
    }
    if(nH2H>0){
      // H2H: pedimos un rango y filtramos
      setStatus(`Buscando H2H ${A.name} vs ${B.name}…`);
      const listA = await lastMatches(A.id, Math.max(nH2H*8, 40));
      const vsB = listA.filter(fx => fx.teams?.home?.id===B.id || fx.teams?.away?.id===B.id).slice(0, nH2H);
      for(const fx of vsB) await processFx(fx);
    }

    if(blocks.length===0){ alert('Sin resultados con esos parámetros'); setStatus('Sin resultados'); progressHide(); return; }

    const header = `Contexto:
Equipo A: ${A.name} | Equipo B: ${B.name} | #A: ${$('#nA').value||'0'} | #B: ${$('#nB').value||'0'} | H2H: ${$('#nH2H').value||'0'} | Competición: ${$('#competicionGlobal').value||'-'}

`;
    $('#out').textContent = header + blocks.join('\n\n');
    setStatus('Listo ✅'); progress(100,'Completado'); setTimeout(progressHide,800);
  }catch(err){
    log('ERROR: '+(err.message||err));
    setStatus('Error'); progressHide(); alert(err.message||err);
  }
}
</script>
</body>
</html>
